<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disparador WhatsApp - WPPConnect</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .content {
            padding: 40px;
        }

        .section {
            margin-bottom: 30px;
            padding: 25px;
            border: 2px solid #f0f0f0;
            border-radius: 15px;
            transition: all 0.3s ease;
        }

        .section:hover {
            border-color: #25d366;
            box-shadow: 0 5px 15px rgba(37, 211, 102, 0.1);
        }

        .section-title {
            font-size: 1.3rem;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .icon {
            width: 24px;
            height: 24px;
            fill: #25d366;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #25d366;
        }

        .file-upload {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-upload input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-upload-label {
            display: block;
            padding: 15px;
            border: 2px dashed #25d366;
            border-radius: 8px;
            text-align: center;
            background: #f8fff9;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload-label:hover {
            background: #e8f5e8;
        }

        .btn {
            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(37, 211, 102, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
        }

        .status.connecting {
            background: #fff3cd;
            color: #856404;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #25d366, #128c7e);
            width: 0%;
            transition: width 0.3s ease;
        }

        .logs {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }

        .csv-preview {
            margin-top: 15px;
            overflow-x: auto;
        }

        .csv-preview table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .csv-preview th,
        .csv-preview td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .csv-preview th {
            background: #f2f2f2;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì± Disparador WhatsApp</h1>
            <p>Sistema completo para envio de mensagens em massa</p>
        </div>
        
        <div class="content">
            <!-- Se√ß√£o de Conex√£o -->
            <div class="section">
                <div class="section-title">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M16.75 13.96c.25.13.41.2.46.3.06.11.04.61-.21 1.18-.2.56-1.24 1.1-1.7 1.12-.46.02-.47.36-2.96-.73-2.49-1.09-3.99-3.75-4.11-3.92-.12-.17-.96-1.38-.92-2.61.05-1.24.69-1.77.93-2.01.24-.24.53-.29.70-.29l.48.01c.15.01.29-.01.53.77l.59 1.79c.05.15.05.31-.06.49-.11.18-.29.39-.42.52-.13.13-.27.27-.16.5.11.23.49.84 1.15 1.35.66.51 1.43.74 1.65.82.22.08.35.07.48-.11.13-.18.56-.65.72-.87.16-.22.32-.18.53-.11l1.06.46M12 2a10 10 0 1 1 0 20 10 10 0 0 1 0-20m0 1.8a8.2 8.2 0 1 0 0 16.4 8.2 8.2 0 0 0 0-16.4z"/>
                    </svg>
                    1. Conectar WhatsApp
                </div>
                <button id="connectBtn" class="btn">Conectar WhatsApp</button>
                <div id="connectionStatus" class="status" style="display: none;"></div>
                <div id="qrCode" style="text-align: center; margin-top: 20px;"></div>
            </div>

            <!-- Se√ß√£o de Upload CSV -->
            <div class="section">
                <div class="section-title">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                    </svg>
                    2. Carregar Lista CSV
                </div>
                <div class="form-group">
                    <label>Arquivo CSV (colunas: telefone, nome, mensagem)</label>
                    <div class="file-upload">
                        <input type="file" id="csvFile" accept=".csv" />
                        <label for="csvFile" class="file-upload-label">
                            üìÅ Clique para selecionar o arquivo CSV
                        </label>
                    </div>
                </div>
                <div id="csvPreview" class="csv-preview" style="display: none;"></div>
            </div>

            <!-- Se√ß√£o de Configura√ß√µes -->
            <div class="section">
                <div class="section-title">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>
                    </svg>
                    3. Configura√ß√µes
                </div>
                <div class="form-group">
                    <label>Delay entre mensagens (segundos)</label>
                    <input type="number" id="delay" value="5" min="1" max="60" />
                </div>
                <div class="form-group">
                    <label>Hor√°rio para come√ßar (Hor√°rio de Bras√≠lia)</label>
                    <input type="time" id="startTime" />
                </div>
                <div class="form-group">
                    <label>Mensagem personalizada (opcional - substitui a do CSV)</label>
                    <textarea id="customMessage" rows="4" placeholder="Use {nome} para personalizar com o nome do contato"></textarea>
                </div>
            </div>

            <!-- Se√ß√£o de Controle -->
            <div class="section">
                <div class="section-title">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M8,5.14V19.14L19,12.14L8,5.14Z"/>
                    </svg>
                    4. Iniciar Disparo
                </div>
                <button id="startSending" class="btn" disabled>Iniciar Envio</button>
                <button id="stopSending" class="btn" style="background: #dc3545; display: none;">Parar Envio</button>
                
                <div id="progress" style="display: none;">
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill"></div>
                    </div>
                    <div id="progressText">0 de 0 mensagens enviadas</div>
                </div>
            </div>

            <!-- Se√ß√£o de Logs -->
            <div class="section">
                <div class="section-title">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M13,9H18.5L13,3.5V9M6,2H14L20,8V20A2,2 0 0,1 18,22H6C4.89,22 4,21.1 4,20V4C4,2.89 4.89,2 6,2M15,18V16H6V18H15M18,14V12H6V14H18Z"/>
                    </svg>
                    Logs do Sistema
                </div>
                <div id="logs" class="logs"></div>
            </div>
        </div>
    </div>

    <script>
        // Estado da aplica√ß√£o
        let isConnected = false;
        let csvData = [];
        let isSending = false;
        let currentIndex = 0;
        let sendingInterval = null;

        // Elementos DOM
        const connectBtn = document.getElementById('connectBtn');
        const connectionStatus = document.getElementById('connectionStatus');
        const qrCode = document.getElementById('qrCode');
        const csvFile = document.getElementById('csvFile');
        const csvPreview = document.getElementById('csvPreview');
        const delayInput = document.getElementById('delay');
        const startTimeInput = document.getElementById('startTime');
        const customMessageInput = document.getElementById('customMessage');
        const startSendingBtn = document.getElementById('startSending');
        const stopSendingBtn = document.getElementById('stopSending');
        const progress = document.getElementById('progress');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const logs = document.getElementById('logs');

        // Fun√ß√µes de utilidade
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('pt-BR');
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#333';
            logEntry.textContent = `[${timestamp}] ${message}`;
            logs.appendChild(logEntry);
            logs.scrollTop = logs.scrollHeight;
        }

        function showStatus(message, type) {
            connectionStatus.style.display = 'block';
            connectionStatus.className = `status ${type}`;
            connectionStatus.textContent = message;
        }

        function updateProgress() {
            if (csvData.length === 0) return;
            
            const percentage = (currentIndex / csvData.length) * 100;
            progressFill.style.width = `${percentage}%`;
            progressText.textContent = `${currentIndex} de ${csvData.length} mensagens enviadas`;
        }

        // Simula√ß√£o da conex√£o WhatsApp (WPPConnect)
        connectBtn.addEventListener('click', async () => {
            connectBtn.disabled = true;
            connectBtn.textContent = 'Conectando...';
            showStatus('Conectando ao WhatsApp...', 'connecting');
            addLog('Iniciando conex√£o com WhatsApp via WPPConnect');

            // Simula o QR Code
            qrCode.innerHTML = `
                <div style="padding: 20px; border: 2px solid #25d366; border-radius: 10px; background: #f8fff9; margin-top: 15px;">
                    <h3 style="margin-bottom: 15px;">üì± Escaneie o QR Code</h3>
                    <div style="width: 200px; height: 200px; border: 1px solid #ccc; margin: 0 auto; background: #fff; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #666;">
                        QR CODE SIMULADO<br>
                        (Em produ√ß√£o seria o QR real)
                    </div>
                    <p style="margin-top: 15px; color: #666;">Abra o WhatsApp no seu celular e escaneie o c√≥digo</p>
                </div>
            `;

            // Simula o tempo de conex√£o
            setTimeout(() => {
                isConnected = true;
                connectBtn.textContent = '‚úÖ Conectado';
                connectBtn.style.background = '#28a745';
                showStatus('WhatsApp conectado com sucesso!', 'connected');
                addLog('WhatsApp conectado com sucesso!', 'success');
                qrCode.innerHTML = '';
                checkReadyToSend();
            }, 3000);
        });

        // Upload e processamento do CSV
        csvFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            addLog(`Carregando arquivo: ${file.name}`);
            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 2) {
                        throw new Error('Arquivo CSV deve ter pelo menos 2 linhas (cabe√ßalho + dados)');
                    }

                    // Parse CSV simples
                    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                    csvData = [];

                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(',').map(v => v.trim());
                        if (values.length >= 2) {
                            csvData.push({
                                telefone: values[0].replace(/\D/g, ''), // Remove caracteres n√£o num√©ricos
                                nome: values[1] || 'Cliente',
                                mensagem: values[2] || 'Ol√°!'
                            });
                        }
                    }

                    if (csvData.length === 0) {
                        throw new Error('Nenhum dado v√°lido encontrado no arquivo');
                    }

                    addLog(`Arquivo processado: ${csvData.length} contatos carregados`, 'success');
                    showCsvPreview();
                    checkReadyToSend();

                } catch (error) {
                    addLog(`Erro ao processar CSV: ${error.message}`, 'error');
                }
            };

            reader.readAsText(file);
        });

        function showCsvPreview() {
            csvPreview.style.display = 'block';
            const previewData = csvData.slice(0, 5); // Mostra apenas os primeiros 5
            
            let table = `
                <h4>Preview dos dados (${csvData.length} contatos carregados):</h4>
                <table>
                    <thead>
                        <tr><th>Telefone</th><th>Nome</th><th>Mensagem</th></tr>
                    </thead>
                    <tbody>
            `;

            previewData.forEach(row => {
                table += `<tr><td>${row.telefone}</td><td>${row.nome}</td><td>${row.mensagem}</td></tr>`;
            });

            table += `</tbody></table>`;
            
            if (csvData.length > 5) {
                table += `<p style="margin-top: 10px; color: #666;">... e mais ${csvData.length - 5} contatos</p>`;
            }

            csvPreview.innerHTML = table;
        }

        function checkReadyToSend() {
            startSendingBtn.disabled = !(isConnected && csvData.length > 0);
        }

        // Fun√ß√£o para enviar mensagens
        async function sendMessage(contact) {
            // Simula o envio via WPPConnect
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    // Simula 95% de sucesso
                    if (Math.random() < 0.95) {
                        resolve();
                    } else {
                        reject(new Error('Falha na entrega'));
                    }
                }, 500);
            });
        }

        function formatMessage(template, contact) {
            return template.replace(/\{nome\}/g, contact.nome);
        }

        async function startSending() {
            if (!isConnected || csvData.length === 0) return;

            const startTime = startTimeInput.value;
            const now = new Date();
            const currentTime = now.toTimeString().slice(0, 5);

            // Verifica se deve aguardar hor√°rio espec√≠fico
            if (startTime && startTime !== currentTime) {
                const [hours, minutes] = startTime.split(':').map(Number);
                const targetTime = new Date();
                targetTime.setHours(hours, minutes, 0, 0);

                if (targetTime <= now) {
                    targetTime.setDate(targetTime.getDate() + 1); // Pr√≥ximo dia
                }

                const waitTime = targetTime - now;
                addLog(`Aguardando hor√°rio programado: ${startTime}. Faltam ${Math.ceil(waitTime/60000)} minutos.`);
                
                setTimeout(() => {
                    if (isSending) startSendingProcess();
                }, waitTime);
                
                return;
            }

            startSendingProcess();
        }

        async function startSendingProcess() {
            isSending = true;
            currentIndex = 0;
            
            startSendingBtn.style.display = 'none';
            stopSendingBtn.style.display = 'block';
            progress.style.display = 'block';
            
            addLog('Iniciando envio de mensagens...', 'success');
            
            const delay = parseInt(delayInput.value) * 1000;
            const customMessage = customMessageInput.value.trim();

            for (let i = 0; i < csvData.length && isSending; i++) {
                currentIndex = i;
                const contact = csvData[i];
                
                try {
                    // Determina a mensagem a ser enviada
                    const message = customMessage 
                        ? formatMessage(customMessage, contact)
                        : contact.mensagem;

                    addLog(`Enviando para ${contact.nome} (${contact.telefone})...`);
                    
                    // Simula o envio
                    await sendMessage(contact);
                    
                    addLog(`‚úÖ Mensagem enviada para ${contact.nome}`, 'success');
                    currentIndex = i + 1;
                    updateProgress();
                    
                    // Delay entre mensagens (exceto na √∫ltima)
                    if (i < csvData.length - 1 && isSending) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                    
                } catch (error) {
                    addLog(`‚ùå Erro ao enviar para ${contact.nome}: ${error.message}`, 'error');
                    currentIndex = i + 1;
                    updateProgress();
                    
                    // Continua mesmo com erro
                    if (i < csvData.length - 1 && isSending) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }
            
            if (isSending) {
                addLog('üéâ Envio conclu√≠do!', 'success');
            } else {
                addLog('‚èπÔ∏è Envio interrompido pelo usu√°rio');
            }
            
            stopSending();
        }

        function stopSending() {
            isSending = false;
            startSendingBtn.style.display = 'block';
            stopSendingBtn.style.display = 'none';
            startSendingBtn.disabled = false;
        }

        // Event listeners
        startSendingBtn.addEventListener('click', startSending);
        stopSendingBtn.addEventListener('click', stopSending);

        // Inicializa√ß√£o
        addLog('Sistema inicializado. Conecte o WhatsApp e carregue um arquivo CSV para come√ßar.');
        
        // Define hor√°rio atual como padr√£o
        const now = new Date();
        startTimeInput.value = now.toTimeString().slice(0, 5);
    </script>
</body>
</html>